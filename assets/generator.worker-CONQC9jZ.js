(function(){"use strict";const Lt=Math.sqrt(3),Ct=.5*(Lt-1),$=(3-Lt)/6,Mt=t=>Math.floor(t)|0,mt=new Float64Array([1,1,-1,1,1,-1,-1,-1,1,0,-1,0,1,0,-1,0,0,1,0,-1,0,1,0,-1]);function F(t=Math.random){const a=kt(t),o=new Float64Array(a).map(i=>mt[i%12*2]),n=new Float64Array(a).map(i=>mt[i%12*2+1]);return function(y,h){let z=0,N=0,w=0;const _=(y+h)*Ct,C=Mt(y+_),V=Mt(h+_),tt=(C+V)*$,ct=C-tt,et=V-tt,P=y-ct,b=h-et;let I,L;P>b?(I=1,L=0):(I=0,L=1);const m=P-I+$,k=b-L+$,c=P-1+2*$,s=b-1+2*$,l=C&255,D=V&255;let M=.5-P*P-b*b;if(M>=0){const A=l+a[D],p=o[A],T=n[A];M*=M,z=M*M*(p*P+T*b)}let u=.5-m*m-k*k;if(u>=0){const A=l+I+a[D+L],p=o[A],T=n[A];u*=u,N=u*u*(p*m+T*k)}let r=.5-c*c-s*s;if(r>=0){const A=l+1+a[D+1],p=o[A],T=n[A];r*=r,w=r*r*(p*c+T*s)}return 70*(z+N+w)}}function kt(t){const o=new Uint8Array(512);for(let n=0;n<512/2;n++)o[n]=n;for(let n=0;n<512/2-1;n++){const i=n+~~(t()*(256-n)),y=o[n];o[n]=o[i],o[i]=y}for(let n=256;n<512;n++)o[n]=o[n-256];return o}const e={x:48,y:96,z:48};function v(t,a,o){return a*(e.x*e.z)+o*e.x+t}function Ot(t){return t&&t.type==="GEN_CHUNK"&&t.payload&&typeof t.payload.key=="string"&&typeof t.payload.cx=="number"&&typeof t.payload.cy=="number"&&typeof t.payload.cz=="number"&&typeof t.payload.seed=="number"}const G=42,ut=3,Ft=.7,Dt=.02,Ht=.15,Tt=.008,Pt=25,bt=.02,Wt=12,Rt=.08,Gt=2,st=.015,_t=6,gt=-.3,Ut=8,Nt=.012,It=.01,q=.006,xt=4,Vt=7,B=5;function H(t){let a=t>>>0;return()=>{a+=1831565813;let o=Math.imul(a^a>>>15,1|a);return o^=o+Math.imul(o^o>>>7,61|o),((o^o>>>14)>>>0)/4294967296}}function ht(t,a,o,n=4,i=2,y=.5){let h=1,z=0,N=0,w=a,_=o;for(let C=0;C<n;C++)z+=t(w,_)*h,N+=h,w*=i,_*=i,h*=y;return N>0?z/N:0}function Y(t,a,o){const n=Math.min(1,Math.max(0,(o-t)/(a-t)));return n*n*(3-2*n)}function Xt(t,a){const o=H(t^2654435769),n=H(t^2246822507),i=H(t^3266489909),y=H(t^668265263),h=H(t^2722868950),z=H(t^1003724304),N=H(t^439041101),w=H(t^1601842716),_=F(o),C=F(n),V=F(i),tt=F(y),ct=F(h),et=F(z),P=F(N),b=F(w),I=a||336/2;return(L,m)=>{const k=ct(L*st,m*st)*_t,c=et(L*st,m*st)*_t,s=L+k,l=m+c,M=Math.sqrt(L*L+m*m)/I,u=_(L*Dt,m*Dt),r=Ft+u*Ht;if(!(M<r)){const W=ht((K,j)=>b(K*Nt,j*Nt),L,m,3,2,.5),X=Math.max(0,M-r),Z=1-r,yt=Math.min(1,X/Z),At=Y(0,1,yt),it=2,E=it+(25-it)*At,g=W*3,S=E+g,x=G-Math.floor(S);return{height:Math.max(ut+1,x),isLand:!1}}const p=1-Y(r*.6,r*.95,M),T=G+p*20,O=ht((W,X)=>C(W*Tt,X*Tt),s,l,4,2,.6)*Pt*p,d=ht((W,X)=>V(W*bt,X*bt),s,l,3,2,.5)*Wt*p,at=tt(s*Rt,l*Rt)*Gt,dt=P(L*.01,m*.01),Et=dt<gt?(dt-gt)*Ut*p:0,ot=T+O+d+at+Et;return{height:Math.floor(Math.max(ut+1,ot)),isLand:!0}}}self.onmessage=t=>{const a=t.data;Ot(a)?Kt(a):console.warn("[GeneratorWorker] Unknown request type:",a)};function Kt(t){const{key:a,cx:o,cy:n,cz:i,seed:y,worldRadius:h}=t.payload,z=Xt(y,h),N=F(H(y^2135587861)),w=e.x*e.y*e.z,_=new Uint8Array(w);Yt(_,o,n,i,z,N,y);const V={type:"CHUNK_DATA",key:a,payload:{size:e,voxels:_}};self.postMessage(V,{transfer:[_.buffer]})}function Yt(t,a,o,n,i,y,h){for(let c=0;c<e.x;c++)for(let s=0;s<e.z;s++){const l=a*e.x+c,D=n*e.z+s,M=i(l,D),{height:u,isLand:r}=M,A=i(l+1,D).height,p=i(l,D+1).height,T=Math.max(Math.abs(A-u),Math.abs(p-u)),Q=u-G;for(let O=0;O<e.y;O++){const R=o*e.y+O,d=v(c,O,s);R<=u?R<ut?t[d]=3:R===u?r?Q<=3?t[d]=4:T>=3?t[d]=3:t[d]=1:t[d]=4:R>u-4&&R<u?!r||Q<=3?t[d]=4:t[d]=2:t[d]=3:R<=G&&(r&&R===G&&u<R||!r&&R===G)?t[d]=5:t[d]=0}}for(let c=0;c<e.x;c++)for(let s=0;s<e.z;s++){const l=a*e.x+c,D=n*e.z+s,{height:M,isLand:u}=i(l,D);if(!u)continue;const r=M-o*e.y,A=r+1;if(r<0||r>=e.y||A<0||A>=e.y)continue;const p=v(c,r,s);if(t[p]!==1)continue;const T=v(c,A,s);if(t[T]!==0)continue;const Q=(y(l*q,D*q)+1)*.5,d=.4*(.3+1.4*Y(.55,.95,Q));U(l,D,911^h)<d&&(t[T]=9)}const b=a*e.x,I=n*e.z,L=b+e.x-1,m=I+e.z-1,k=3;for(let c=b-k;c<=L+k;c++)for(let s=I-k;s<=m+k;s++){const{height:l,isLand:D}=i(c,s),M=Math.max(Math.abs(i(c+1,s).height-l),Math.abs(i(c,s+1).height-l)),u=l-G;if(!D||u<=3||M>=3)continue;const r=(y(c*q,s*q)+1)*.5,A=Y(.6,.86,r),p=Y(2,14,u),T=It*(.05+6*A)*p;if(U(c,s,1337^h)>=T)continue;const O=U(c,s,3490574349^h|0),R=B*B;let d=!1;for(let f=c-B;!d&&f<=c+B;f++)for(let E=s-B;E<=s+B;E++){if(f===c&&E===s)continue;const g=f-c,S=E-s;if(g*g+S*S>R)continue;const x=i(f,E);if(!x.isLand)continue;const K=Math.max(Math.abs(i(f+1,E).height-x.height),Math.abs(i(f,E+1).height-x.height)),j=x.height-G;if(j<=3||K>=3)continue;const rt=(y(f*q,E*q)+1)*.5,lt=Y(.6,.86,rt),zt=Y(2,14,j),ft=It*(.05+6*lt)*zt;if(U(f,E,1337^h)>=ft)continue;const J=U(f,E,3490574349^h|0);if(J<O||J===O&&(f<c||f===c&&E<s)){d=!0;break}}if(d)continue;const nt=xt+Math.floor(U(c,s,4242^h)*(Vt-xt+1)),at=Math.max(1,Math.min(3,Math.floor(nt*.5))),Et=U(c,s,519835646^h|0)<.8?7:8,ot=c-b,W=s-I;if(ot>=0&&ot<e.x&&W>=0&&W<e.z)for(let f=1;f<=nt;f++){const g=l+f-o*e.y;if(g<0||g>=e.y)continue;const S=v(ot,g,W);t[S]=6}const X=l+nt,Z=[];at<=1?Z.push({dy:-1,r:1},{dy:0,r:1},{dy:1,r:0}):at===2?Z.push({dy:-1,r:2},{dy:0,r:2},{dy:1,r:1},{dy:2,r:0}):Z.push({dy:-2,r:2},{dy:-1,r:3},{dy:0,r:3},{dy:1,r:2},{dy:2,r:1});const yt=Z.reduce((f,E)=>Math.min(f,E.dy),0),At=X+yt,it=Math.max(0,l+4-At);for(const f of Z){const E=X+f.dy+it,g=E-o*e.y;if(g<0||g>=e.y)continue;const S=f.r;for(let x=-S;x<=S;x++)for(let K=-S;K<=S;K++){const j=Math.abs(x),rt=Math.abs(K),lt=Math.max(j,rt);if(lt>S||j===S&&rt===S&&S>0)continue;const ft=c+x,St=s+K,J=ft-b,pt=St-I;if(J<0||J>=e.x||pt<0||pt>=e.z)continue;if(S>0&&lt===S-0){const Zt=h^E<<1|0;if(U(ft,St,Zt)<.05)continue}const wt=v(J,g,pt);t[wt]===0&&(t[wt]=Et)}}}}function U(t,a,o){let n=0;return n=Math.imul(t|0,374761393)^Math.imul(a|0,668265263)^Math.imul(o|0,2654435761)|0,n=n^n>>>13|0,n=Math.imul(n,1274126177),n=(n^n>>>16)>>>0,n/4294967296}})();
