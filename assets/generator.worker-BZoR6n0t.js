(function(){"use strict";const rt=Math.sqrt(3),Dt=.5*(rt-1),X=(3-rt)/6,lt=t=>Math.floor(t)|0,ft=new Float64Array([1,1,-1,1,1,-1,-1,-1,1,0,-1,0,1,0,-1,0,0,1,0,-1,0,1,0,-1]);function H(t=Math.random){const s=Tt(t),o=new Float64Array(s).map(a=>ft[a%12*2]),n=new Float64Array(s).map(a=>ft[a%12*2+1]);return function(E,A){let I=0,g=0,x=0;const T=(E+A)*Dt,C=lt(E+T),k=lt(A+T),K=(C+k)*X,Y=C-K,F=k-K,p=E-Y,w=A-F;let W,r;p>w?(W=1,r=0):(W=0,r=1);const e=p-W+X,i=w-r+X,d=p-1+2*X,M=w-1+2*X,_=C&255,f=k&255;let h=.5-p*p-w*w;if(h>=0){const S=_+s[f],y=o[S],u=n[S];h*=h,I=h*h*(y*p+u*w)}let b=.5-e*e-i*i;if(b>=0){const S=_+W+s[f+r],y=o[S],u=n[S];b*=b,g=b*b*(y*e+u*i)}let L=.5-d*d-M*M;if(L>=0){const S=_+1+s[f+1],y=o[S],u=n[S];L*=L,x=L*L*(y*d+u*M)}return 70*(I+g+x)}}function Tt(t){const o=new Uint8Array(512);for(let n=0;n<512/2;n++)o[n]=n;for(let n=0;n<512/2-1;n++){const a=n+~~(t()*(256-n)),E=o[n];o[n]=o[a],o[a]=E}for(let n=256;n<512;n++)o[n]=o[n-256];return o}const c={x:48,y:96,z:48};function tt(t,s,o){return s*(c.x*c.z)+o*c.x+t}function gt(t){return t&&t.type==="GEN_CHUNK"&&t.payload&&typeof t.payload.key=="string"&&typeof t.payload.cx=="number"&&typeof t.payload.cy=="number"&&typeof t.payload.cz=="number"&&typeof t.payload.seed=="number"}const G=42,nt=3,_t=.7,ht=.02,bt=.15,ut=.008,Nt=25,Et=.02,Rt=12,At=.08,It=2,j=.015,dt=6,Lt=-.3,xt=8,yt=.012,Ct=.01,pt=.006,Mt=3,wt=5;function O(t){let s=t>>>0;return()=>{s+=1831565813;let o=Math.imul(s^s>>>15,1|s);return o^=o+Math.imul(o^o>>>7,61|o),((o^o>>>14)>>>0)/4294967296}}function ot(t,s,o,n=4,a=2,E=.5){let A=1,I=0,g=0,x=s,T=o;for(let C=0;C<n;C++)I+=t(x,T)*A,g+=A,x*=a,T*=a,A*=E;return g>0?I/g:0}function q(t,s,o){const n=Math.min(1,Math.max(0,(o-t)/(s-t)));return n*n*(3-2*n)}function zt(t,s){const o=O(t^2654435769),n=O(t^2246822507),a=O(t^3266489909),E=O(t^668265263),A=O(t^2722868950),I=O(t^1003724304),g=O(t^439041101),x=O(t^1601842716),T=H(o),C=H(n),k=H(a),K=H(E),Y=H(A),F=H(I),p=H(g),w=H(x),W=s||336/2;return(r,e)=>{const i=Y(r*j,e*j)*dt,d=F(r*j,e*j)*dt,M=r+i,_=e+d,h=Math.sqrt(r*r+e*e)/W,b=T(r*ht,e*ht),L=_t+b*bt;if(!(h<L)){const N=ot((it,kt)=>w(it*yt,kt*yt),r,e,3,2,.5),R=Math.max(0,h-L),B=1-L,Q=Math.min(1,R/B),J=q(0,1,Q),V=2,v=V+(25-V)*J,ct=N*3,at=v+ct,mt=G-Math.floor(at);return{height:Math.max(nt+1,mt),isLand:!1}}const y=1-q(L*.6,L*.95,h),u=G+y*20,l=ot((N,R)=>C(N*ut,R*ut),M,_,4,2,.6)*Nt*y,et=ot((N,R)=>k(N*Et,R*Et),M,_,3,2,.5)*Rt*y,z=K(M*At,_*At)*It,D=p(r*.01,e*.01),U=D<Lt?(D-Lt)*xt*y:0,P=u+l+et+z+U;return{height:Math.floor(Math.max(nt+1,P)),isLand:!0}}}self.onmessage=t=>{const s=t.data;gt(s)?Ht(s):console.warn("[GeneratorWorker] Unknown request type:",s)};function Ht(t){const{key:s,cx:o,cy:n,cz:a,seed:E,worldRadius:A}=t.payload,I=zt(E,A),g=H(O(E^2135587861)),x=c.x*c.y*c.z,T=new Uint8Array(x);Ot(T,o,n,a,I,g,E);const k={type:"CHUNK_DATA",key:s,payload:{size:c,voxels:T}};self.postMessage(k,{transfer:[T.buffer]})}function Ot(t,s,o,n,a,E,A){for(let e=0;e<c.x;e++)for(let i=0;i<c.z;i++){const d=s*c.x+e,M=n*c.z+i,_=a(d,M),{height:f,isLand:h}=_,b=a(d+1,M).height,L=a(d,M+1).height,S=Math.max(Math.abs(b-f),Math.abs(L-f)),y=f-G;for(let u=0;u<c.y;u++){const m=o*c.y+u,l=tt(e,u,i);m<=f?m<nt?t[l]=3:m===f?h?y<=3?t[l]=4:S>=3?t[l]=3:t[l]=1:t[l]=4:m>f-4&&m<f?!h||y<=3?t[l]=4:t[l]=2:t[l]=3:m<=G&&(h&&m===G&&f<m||!h&&m===G)?t[l]=5:t[l]=0}}const F=s*c.x,p=n*c.z,w=F+c.x-1,W=p+c.z-1,r=3;for(let e=F-r;e<=w+r;e++)for(let i=p-r;i<=W+r;i++){const{height:d,isLand:M}=a(e,i),_=Math.max(Math.abs(a(e+1,i).height-d),Math.abs(a(e,i+1).height-d)),f=d-G;if(!M||f<=3||_>=3)continue;const h=(E(e*pt,i*pt)+1)*.5,b=q(.6,.86,h),L=q(2,14,f),S=Ct*(.05+6*b)*L;if(st(e,i,1337^A)>=S)continue;const u=Mt+Math.floor(st(e,i,4242^A)*(wt-Mt+1)),m=Math.max(1,Math.min(3,Math.floor(u*.5))),l=e-F,Z=i-p;if(l>=0&&l<c.x&&Z>=0&&Z<c.z)for(let z=1;z<=u;z++){const U=d+z-o*c.y;if(U<0||U>=c.y)continue;const P=tt(l,U,Z);t[P]=6}const et=d+u,St=m+1;for(let z=0;z<St;z++){const D=m-z,U=et+1+z,P=U-o*c.y;if(!(P<0||P>=c.y))for(let N=-D;N<=D;N++)for(let R=-D;R<=D;R++){const B=Math.max(Math.abs(N),Math.abs(R));if(B>D)continue;const Q=e+N,J=i+R,V=Q-F,$=J-p;if(V<0||V>=c.x||$<0||$>=c.z)continue;if(D>0&&B===D){const ct=A^U<<1|0,at=st(Q,J,ct),it=Math.abs(N)===D&&Math.abs(R)===D?.15:.06;if(at<it)continue}const v=tt(V,P,$);t[v]===0&&(t[v]=7)}}}}function st(t,s,o){let n=0;return n=Math.imul(t|0,374761393)^Math.imul(s|0,668265263)^Math.imul(o|0,2654435761)|0,n=n^n>>>13|0,n=Math.imul(n,1274126177),n=(n^n>>>16)>>>0,n/4294967296}})();
